<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/vega@5.20.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.1.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.17.0"></script>
    <title>Malaysia Household Income & Expenditure Analysis</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 40px;
        font-size: 28px;
      }
      .vis-container {
        margin-bottom: 60px;
        width: 100%;
        min-height: 500px;
      }
      hr {
        border: none;
        border-top: 2px solid #e0e0e0;
        margin: 60px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Malaysia Household Income & Expenditure Analysis (2022)</h1>

      <div class="vis-container" id="map"></div>

      <hr />

      <div class="vis-container" id="barchart"></div>
    </div>

    <script type="text/javascript">
      // Map specification
      var mapSpec = {
        $schema: "https://vega.github.io/schema/vega-lite/v5.json",
        width: 850,
        height: 400,
        title: "Mean Household Income by State in Malaysia (2022)",
        projection: {
          type: "mercator",
          center: [109.5, 3],
          scale: 2500,
        },
        layer: [
          {
            data: {
              url: "https://raw.githubusercontent.com/ylee0132/FIT3179/refs/heads/main/W9_hw/malaysia_map.json",
              format: {
                type: "topojson",
                feature: "ne_10m_ocean",
              },
            },
            mark: {
              type: "geoshape",
              fill: "lightblue",
            },
          },
          {
            data: {
              url: "https://raw.githubusercontent.com/ylee0132/FIT3179/refs/heads/main/W9_hw/malaysia_map.json",
              format: {
                type: "topojson",
                feature: "ne_10m_graticules_30",
              },
            },
            mark: {
              type: "geoshape",
              fill: null,
              stroke: "lightgray",
              strokeWidth: 0.5,
            },
          },
          {
            data: {
              url: "https://raw.githubusercontent.com/ylee0132/FIT3179/refs/heads/main/W9_hw/malaysia_map.json",
              format: {
                type: "topojson",
                feature: "ne_10m_admin_1_states_provinces",
              },
            },
            transform: [
              {
                lookup: "properties.name",
                from: {
                  data: {
                    url: "https://raw.githubusercontent.com/ylee0132/FIT3179/refs/heads/main/W9_hw/hies_district.csv",
                  },
                  key: "state",
                  fields: [
                    "income_mean",
                    "income_median",
                    "expenditure_mean",
                    "gini",
                    "poverty",
                  ],
                },
              },
            ],
            mark: {
              type: "geoshape",
              stroke: "white",
              strokeWidth: 1,
            },
            encoding: {
              color: {
                field: "income_mean",
                type: "quantitative",
                scale: {
                  scheme: "oranges",
                },
                legend: {
                  title: "Mean Income (RM)",
                },
              },
              tooltip: [
                { field: "properties.name", type: "nominal", title: "State" },
                {
                  field: "income_mean",
                  type: "quantitative",
                  title: "Mean Income (RM)",
                  format: ",.0f",
                },
                {
                  field: "income_median",
                  type: "quantitative",
                  title: "Median Income (RM)",
                  format: ",.0f",
                },
                {
                  field: "gini",
                  type: "quantitative",
                  title: "Gini Coefficient",
                  format: ".4f",
                },
                {
                  field: "poverty",
                  type: "quantitative",
                  title: "Poverty Rate (%)",
                  format: ".1f",
                },
              ],
            },
          },
        ],
      };

      // Bar chart specification with annotations
      var barSpec = {
        $schema: "https://vega.github.io/schema/vega-lite/v5.json",
        width: 850,
        height: 450,
        title: {
          text: "Mean Income vs Mean Expenditure by State (2022)",
          fontSize: 16,
          anchor: "middle",
        },
        params: [
          {
            name: "pov_slider",
            value: 15,
            bind: {
              input: "range",
              min: 0,
              max: 15,
              step: 0.5,
              name: "Max Poverty Rate (%): ",
            },
          },
        ],
        data: {
          url: "https://raw.githubusercontent.com/ylee0132/FIT3179/refs/heads/main/W9_hw/hies_district.csv",
          format: { type: "csv" },
        },
        transform: [
          { filter: "datum.poverty <= pov_slider" },
          {
            aggregate: [
              { op: "mean", field: "income_mean", as: "income" },
              { op: "mean", field: "expenditure_mean", as: "expenditure" },
              { op: "mean", field: "poverty", as: "poverty_avg" },
              { op: "mean", field: "gini", as: "gini_avg" },
            ],
            groupby: ["state"],
          },
          {
            fold: ["income", "expenditure"],
            as: ["category", "amount"],
          },
          {
            calculate:
              "datum.category == 'income' ? 'Mean Income' : 'Mean Expenditure'",
            as: "category_name",
          },
        ],
        layer: [
          {
            mark: { type: "bar" },
            encoding: {
              x: {
                field: "state",
                type: "nominal",
                title: "State",
                axis: { labelAngle: -45, labelFontSize: 11 },
                sort: {
                  field: "amount",
                  op: "mean",
                  order: "descending",
                },
              },
              y: {
                field: "amount",
                type: "quantitative",
                title: "Amount (RM)",
                axis: { format: ",.0f", grid: true },
              },
              xOffset: { field: "category_name" },
              color: {
                field: "category_name",
                type: "nominal",
                title: "Category",
                scale: {
                  domain: ["Mean Income", "Mean Expenditure"],
                  range: ["#ff7f0e", "#1f77b4"],
                },
                legend: {
                  orient: "top-right",
                  titleFontSize: 12,
                  labelFontSize: 11,
                },
              },
              tooltip: [
                { field: "state", type: "nominal", title: "State" },
                { field: "category_name", type: "nominal", title: "Category" },
                {
                  field: "amount",
                  type: "quantitative",
                  title: "Amount (RM)",
                  format: ",.2f",
                },
                {
                  field: "poverty_avg",
                  type: "quantitative",
                  title: "Poverty Rate (%)",
                  format: ".2f",
                },
                {
                  field: "gini_avg",
                  type: "quantitative",
                  title: "Gini Coefficient",
                  format: ".4f",
                },
              ],
            },
          },
          {
            data: {
              url: "https://raw.githubusercontent.com/ylee0132/FIT3179/refs/heads/main/W9_hw/hies_district.csv",
            },
            transform: [
              { filter: "datum.poverty <= pov_slider" },
              {
                aggregate: [
                  { op: "mean", field: "income_mean", as: "avg_income" },
                ],
                groupby: ["state"],
              },
            ],
            mark: {
              type: "rule",
              color: "black",
              strokeWidth: 2,
              strokeDash: [6, 4],
            },
            encoding: {
              y: {
                aggregate: "mean",
                field: "avg_income",
                type: "quantitative",
              },
            },
          },
          {
            data: {
              url: "https://raw.githubusercontent.com/ylee0132/FIT3179/refs/heads/main/W9_hw/hies_district.csv",
            },
            transform: [
              { filter: "datum.poverty <= pov_slider" },
              {
                aggregate: [
                  { op: "mean", field: "income_mean", as: "avg_income" },
                ],
                groupby: ["state"],
              },
            ],
            mark: {
              type: "text",
              align: "right",
              dx: -5,
              dy: -5,
              fontSize: 11,
              fontWeight: "bold",
              color: "black",
            },
            encoding: {
              y: {
                aggregate: "mean",
                field: "avg_income",
                type: "quantitative",
              },
              text: {
                aggregate: "mean",
                field: "avg_income",
                type: "quantitative",
                format: ",.0f",
              },
              x: { value: 845 },
            },
          },
          {
            data: {
              url: "https://raw.githubusercontent.com/ylee0132/FIT3179/refs/heads/main/W9_hw/hies_district.csv",
            },
            transform: [
              { filter: "datum.poverty <= pov_slider" },
              {
                aggregate: [
                  { op: "mean", field: "income_mean", as: "avg_income" },
                ],
                groupby: ["state"],
              },
            ],
            mark: {
              type: "text",
              align: "right",
              dx: -5,
              dy: 15,
              fontSize: 10,
              color: "black",
            },
            encoding: {
              y: {
                aggregate: "mean",
                field: "avg_income",
                type: "quantitative",
              },
              text: { value: "National Average Income" },
              x: { value: 845 },
            },
          },
        ],
      };

      // Embed map first, then bar chart after map is loaded
      vegaEmbed("#map", mapSpec, { actions: false })
        .then(function () {
          vegaEmbed("#barchart", barSpec, { actions: false }).catch(
            console.error
          );
        })
        .catch(console.error);
    </script>
  </body>
</html>
